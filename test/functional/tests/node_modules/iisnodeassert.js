var http = require("http");
var assert = require("assert");

process.on('uncaughtException', function (err) {
    console.error(err);
    console.stdout.flush();
    console.stderr.flush();
    process.kill(process.pid);
});

exports.get = function (path, expectedStatusCode, expectedBody) {
    var options = {
        host: "localhost",
        port: 31415,
        method: "GET",
        path: path,
    };

    console.log("request options: " + JSON.stringify(options));

    var request = http.request(options, function(res) {
        console.log("response status: " + res.statusCode);
        console.log("response headers: " + JSON.stringify(res.headers));

        assert.equal(res.statusCode, expectedStatusCode, "response status code matches the expected response status code");

        res.setEncoding("utf8");
        var body = "";
        res.on("data", function(chunk) {
            console.log("response body chunk: " + chunk);
            body += chunk;
        });
        res.on("end", function() {
            console.log("end of response");

            assert.equal(body, expectedBody, "response body matches the expected response body");
        });
    });

    request.on("error", function (e) {
        console.log("problem with request: " + e.message);
        
        assert.ok(false, "response finished successfully");
    });

    request.end();
}