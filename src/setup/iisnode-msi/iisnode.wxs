<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">

  <?if $(var.Platform) = x86 ?>
  <?define sourcedir="$(var.ProjectDir)..\..\..\build\$(var.Configuration)\x86\" ?>
  <?define isWin64="no" ?>
  <?if $(var.ProjectName) = iisnode-msi-full ?>
  <?define productName="iisnode for iis 7.x (x86) full" ?>
  <?else?>
  <?define productName="iisnode for iis 7.x (x86) core" ?>
  <?endif?>
  <?elseif $(var.Platform) = x64 ?>
  <?define sourcedir="$(var.ProjectDir)..\..\..\build\$(var.Configuration)\x64\" ?>
  <?define wowsourcedir="$(var.ProjectDir)..\..\..\build\$(var.Configuration)\x86\" ?>
  <?define isWin64="yes" ?>
  <?if $(var.ProjectName) = iisnode-msi-full ?>
  <?define productName="iisnode for iis 7.x (x64) full" ?>
  <?else?>
  <?define productName="iisnode for iis 7.x (x64) core" ?>
  <?endif?>
  <?endif?>

  <?include version_autogenerated.wxi ?>
  <!-- generated in pre-build steps -->

  <!-- 64 bit installers: 
       http://blogs.msdn.com/b/astebner/archive/2007/08/09/4317654.aspx,
       http://blogs.msdn.com/b/heaths/archive/2005/10/24/windows-installer-on-64-bit-platforms.aspx
   -->

  <Product Id="*"
           Name="$(var.productName)"
           Language="1033"
           Version="$(var.version)"
           Manufacturer="Microsoft Corporation"
           UpgradeCode="1d60944c-b9ce-4a71-a7c0-0384eb884b1f">

    <?if $(var.Platform) = x86 ?>
    <Package InstallerVersion="200" Compressed="yes" Platform="x86" />
    <?elseif $(var.Platform) = x64 ?>
    <Package InstallerVersion="200" Compressed="yes" Platform="x64"/>
    <?endif?>

    <MajorUpgrade AllowSameVersionUpgrades="yes" 
                  DowngradeErrorMessage="A later version of [ProductName] is already installed and cannot be replaced. If you intend to downgrade the version of [ProductName], please uninstall the current version manually." />

    <Media Id="1" Cabinet="media1.cab" EmbedCab="yes" />

    <Property Id="ALLUSERS" Value="1" />

    <Property Id="NODEEXE32">
      <DirectorySearch Id="NodeDir32" Path="[ProgramFilesFolder]nodejs">
        <FileSearch Name="node.exe" />
      </DirectorySearch>
    </Property>

    <Property Id="NODEEXE64">
      <DirectorySearch Id="NodeDir64" Path="[ProgramFiles64Folder]nodejs">
        <FileSearch Name="node.exe" />
      </DirectorySearch>
    </Property>

    <Property Id="VCREDIST2012INSTALLED">
      <?if $(var.isWin64) = "yes"?>
      <RegistrySearch Id="VCRedist2012Search64" Root="HKLM" Key="Software\Wow6432Node\Microsoft\Windows\CurrentVersion\Uninstall\{15134cb0-b767-4960-a911-f2d16ae54797}" Name="Installed" Type="raw" />
      <?else?>
      <RegistrySearch Id="VCRedist2012Search32" Root="HKLM" Key="Software\Microsoft\Windows\CurrentVersion\Uninstall\{22154f09-719a-4619-bb71-5b3356999fbf}" Name="Installed" Type="raw" />
      <?endif?>
    </Property>
    
    <PropertyRef Id="IISMAJORVERSION" />

    <?if $(var.isWin64) = "yes"?>
    <Condition Message="Microsoft Visual C++ 2012 Redistributable Package (x64) is required but not installed. Please install it then rerun this installer.">
      <![CDATA[Installed OR VCREDIST2012INSTALLED]]>
    </Condition>
    <?else?>
    <Condition Message="Microsoft Visual C++ 2012 Redistributable Package (x86) is required but not installed. Please install it then rerun this installer.">
      <![CDATA[Installed OR VCREDIST2012INSTALLED]]>
    </Condition>
    <?endif?>

    <Condition Message="IIS 7.x or later must be installed before iisnode installation.">
      <![CDATA[IISMAJORVERSION >= "#7"]]>
    </Condition>

    <Condition Message="Node.js x64 is not found in the [ProgramFiles64Folder]\nodejs folder. Please install node.js x64 and restart this installer.">
      <![CDATA[Installed OR NOT(VersionNT64) OR NODEEXE64 OR WOW]]>
    </Condition>

    <Condition Message="Node.js x86 is not found in the [ProgramFilesFolder]\nodejs folder. Please install node.js x86 and restart this installer.">
      <![CDATA[Installed OR (VersionNT64 and NOT(WOW)) OR NODEEXE32]]>
    </Condition>

    <Directory Id="TARGETDIR" Name="SourceDir">
      <?if $(var.isWin64) = "yes" ?>
      <Directory Id="System64Folder" />
      <?endif?>
    </Directory>

    <Feature Id="iisnode4iis" Title="Hosting node.js applications in IIS 7.x" Level="1" Description="IIS 7.x native module for hosting node.js applications in IIS">
      <ComponentGroupRef Id="allfiles" />
      <Condition Level="0">WOW</Condition>
    </Feature>

    <?if $(var.isWin64) = "yes" ?>
    <Feature Id="iisnode4iiswow" Title="Hosting node.js applications in IIS 7.x in WOW mode" Level="1" Description="IIS 7.x native module for hosting node.js applications in IIS in WOW mode">
      <ComponentGroupRef Id="allfileswow" />
      <Condition Level="0">NOT WOW</Condition>
    </Feature>
    <?endif?>

    <?if $(var.ProjectName) = iisnode-msi-full ?>
    <WixVariable Id="WixUILicenseRtf" Value="$(var.ProjectDir)\License.rtf" />
    <?else?>
    <WixVariable Id="WixUILicenseRtf" Value="$(var.ProjectDir)\License_core.rtf" />
    <?endif?>
    <UIRef Id="WixUI_Minimal" />

    <InstallExecuteSequence>

      <?if $(var.isWin64) = "no" ?>
      <Custom Action="CA_Err32BitMsiOn64BitOS" After="LaunchConditions">
        <![CDATA[MsiAMD64 OR Intel64]]>
      </Custom>
      <?endif ?>

      <!-- Conditions for custom actions:
         http://stackoverflow.com/questions/537584/how-to-execute-custom-action-only-in-install-not-uninstall
         http://stackoverflow.com/questions/128279/how-best-to-define-a-custom-action-in-wix 
      -->

      <!-- install/rollback/uninstall iisnode section under system.webServer -->

      <Custom Action="AddIisnodeSection" After="InstallFiles">REMOVE&lt;>"ALL"</Custom>
      <Custom Action="RollbackAddIisnodeSection" After="InstallFiles">REMOVE&lt;>"ALL"</Custom>
      <Custom Action="UndoAddIisnodeSection" After="InstallFiles">REMOVE="ALL"</Custom>

      <!-- remove iisnode module registration -->

      <Custom Action="RemoveIisnodeModuleRegistration" After="AddIisnodeSection" />

      <!-- install/rollback/uninstall iisnode module -->

      <?if $(var.isWin64) = "yes" ?>
      <Custom Action="AddIisnodeModuleRegistration" After="RemoveIisnodeModuleRegistration">(REMOVE&lt;>"ALL") AND (NOT WOW)</Custom>      
      <Custom Action="AddIisnodeModuleRegistrationWow" After="RemoveIisnodeModuleRegistration">(REMOVE&lt;>"ALL") AND WOW</Custom>
      <?else?>
      <Custom Action="AddIisnodeModuleRegistration" After="RemoveIisnodeModuleRegistration">REMOVE&lt;>"ALL"</Custom>
      <?endif?>
      <Custom Action="RollbackAddIisnodeModuleRegistration" After="RemoveIisnodeModuleRegistration">REMOVE&lt;>"ALL"</Custom>
      <Custom Action="UndoAddIisnodeModuleRegistration" After="RemoveIisnodeModuleRegistration">REMOVE="ALL"</Custom>

      <!-- grant permissions for default IIS user to read and execute pre-installed node.exe -->

      <Custom Action="AddPermissionsToNodeExeForDefaultIISUser" After="AddIisnodeModuleRegistration">REMOVE&lt;>"ALL"</Custom>

    </InstallExecuteSequence>

  </Product>

  <?if $(var.Platform) = x86 ?>
  <?include iisnodefiles.wxi ?>
  <?elseif $(var.Platform) = x64 ?>
  <?include iisnodefiles64.wxi ?>
  <?include iisnodefiles64wow.wxi ?>
  <?endif?>

  <?include customactions.wxi ?>

</Wix>
